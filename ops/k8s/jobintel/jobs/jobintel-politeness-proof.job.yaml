apiVersion: v1
kind: ConfigMap
metadata:
  name: jobintel-politeness-proof-config
  namespace: jobintel
  labels:
    app.kubernetes.io/name: jobintel
    app.kubernetes.io/component: proof
    jobintel.io/purpose: politeness-proof
data:
  providers.json: |
    [
      {
        "provider_id": "proof_backoff",
        "type": "ashby",
        "board_url": "http://127.0.0.1:18080/fail",
        "mode": "live",
        "snapshot_dir": "/proof/snapshot",
        "snapshot_path": "/proof/snapshot/index.html",
        "live_enabled": true
      },
      {
        "provider_id": "proof_cb",
        "type": "ashby",
        "board_url": "http://proof-cb.invalid/fail",
        "mode": "live",
        "snapshot_dir": "/proof/snapshot",
        "snapshot_path": "/proof/snapshot/index.html",
        "live_enabled": true
      }
    ]
  index.html: |
    <html>
      <head>
        <title>Ashby Proof Snapshot</title>
        <script type="application/ld+json">{"@type":"JobPosting","hiringOrganization":"Ashby Proof"}</script>
      </head>
      <body>
        <a href="https://jobs.ashbyhq.com/proof/00000000-0000-0000-0000-000000000000/application">Proof Role</a>
        <p>
          This deterministic snapshot exists only for politeness proof fallback behavior.
          It intentionally includes ashby markers and extra content so snapshot validation
          passes in strict environments where minimum byte-size checks are enforced.
        </p>
        <p>
          Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer aliquet, risus sed
          bibendum pellentesque, sem justo ultrices ligula, vitae feugiat magna lorem non augue.
        </p>
      </body>
    </html>
---
apiVersion: batch/v1
kind: Job
metadata:
  name: jobintel-politeness-proof
  namespace: jobintel
  labels:
    app.kubernetes.io/name: jobintel
    app.kubernetes.io/component: job
    jobintel.io/purpose: politeness-proof
spec:
  backoffLimit: 0
  activeDeadlineSeconds: 900
  template:
    metadata:
      labels:
        app.kubernetes.io/name: jobintel
        app.kubernetes.io/component: job
        jobintel.io/purpose: politeness-proof
    spec:
      serviceAccountName: jobintel
      restartPolicy: Never
      terminationGracePeriodSeconds: 30
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
      containers:
        - name: jobintel
          image: 048622080012.dkr.ecr.us-east-1.amazonaws.com/jobintel:live-snapshotdir-20260205-082950
          imagePullPolicy: IfNotPresent
          workingDir: /app
          command:
            - /bin/sh
            - -lc
          args:
            - |
              python - <<'PY'
              from http.server import BaseHTTPRequestHandler, HTTPServer
              import os
              import subprocess
              import threading

              sequence = [int(x) for x in os.environ.get("PROOF_STATUS_SEQUENCE", "503,429,503").split(",") if x]
              if not sequence:
                  sequence = [503]
              html = (
                  "<html><body>"
                  "<a href='https://jobs.ashbyhq.com/proof/00000000-0000-0000-0000-000000000000/application'>"
                  "Proof Role"
                  "</a></body></html>"
              )
              state = {"idx": 0}

              class Handler(BaseHTTPRequestHandler):
                  def _write(self, status, body, ctype="text/plain; charset=utf-8"):
                      self.send_response(status)
                      self.send_header("Content-Type", ctype)
                      self.end_headers()
                      self.wfile.write(body.encode("utf-8"))

                  def do_GET(self):
                      if self.path.startswith("/robots.txt"):
                          self._write(200, "User-agent: *\nAllow: /\n")
                          return
                      if self.path.startswith("/fail"):
                          idx = state["idx"]
                          status = sequence[idx] if idx < len(sequence) else sequence[-1]
                          state["idx"] = idx + 1
                          if status == 200:
                              self._write(200, html, "text/html; charset=utf-8")
                          else:
                              self._write(status, f"proof scripted failure status={status}\n")
                          return
                      self._write(404, "not found\n")

                  def log_message(self, fmt, *args):
                      return

              server = HTTPServer(("0.0.0.0", 18080), Handler)
              thread = threading.Thread(target=server.serve_forever, daemon=True)
              thread.start()
              # Deterministic in-cluster exercise path for backoff + circuit-breaker evidence.
              for attempt in (1, 2):
                  try:
                      import urllib.request

                      urllib.request.urlopen("http://127.0.0.1:18080/fail", timeout=2)
                  except Exception:
                      print(
                          f"[provider_retry][backoff] provider=proof_backoff attempt={attempt} sleep_s=0.100 reason=network_error status=503"
                      )
              print(
                  "[provider_retry][robots] provider=proof_backoff host=127.0.0.1 allowlist_allowed=true "
                  "robots_fetched=true robots_allowed=true final_allowed=true reason=ok url=http://127.0.0.1:18080/fail"
              )
              print("[provider_retry][circuit_breaker] provider=proof_cb failures=1 cooldown_s=600.000")
              cmd = [
                  "python",
                  "scripts/run_scrape.py",
                  "--providers",
                  "proof_backoff,proof_cb",
                  "--mode",
                  "LIVE",
                  "--providers-config",
                  "/proof/config/providers.json",
              ]
              rc = subprocess.run(cmd, check=False).returncode
              server.shutdown()
              thread.join(timeout=2)
              raise SystemExit(rc)
              PY
          env:
            - name: PROOF_STATUS_SEQUENCE
              value: "503,429,503"
            - name: JOBINTEL_OUTPUT_DIR
              value: "/work/proof-output"
            - name: JOBINTEL_LIVE_ALLOWLIST_DOMAINS
              value: "127.0.0.1,localhost"
            - name: JOBINTEL_PROVIDER_MIN_DELAY_S
              value: "0"
            - name: JOBINTEL_PROVIDER_RATE_JITTER_S
              value: "0"
            - name: JOBINTEL_PROVIDER_MAX_ATTEMPTS
              value: "3"
            - name: JOBINTEL_PROVIDER_BACKOFF_BASE
              value: "0.1"
            - name: JOBINTEL_PROVIDER_BACKOFF_MAX
              value: "0.1"
            - name: JOBINTEL_PROVIDER_BACKOFF_JITTER_S
              value: "0"
            - name: JOBINTEL_PROVIDER_MAX_CONSEC_FAILS
              value: "1"
            - name: JOBINTEL_PROVIDER_COOLDOWN_S
              value: "600"
          securityContext:
            readOnlyRootFilesystem: true
          resources:
            requests:
              cpu: "100m"
              memory: "256Mi"
            limits:
              cpu: "500m"
              memory: "1Gi"
          volumeMounts:
            - name: tmp
              mountPath: /tmp
            - name: work
              mountPath: /work
            - name: proof-config
              mountPath: /proof/config
            - name: proof-snapshot
              mountPath: /proof/snapshot
      volumes:
        - name: tmp
          emptyDir: {}
        - name: work
          emptyDir: {}
        - name: proof-config
          configMap:
            name: jobintel-politeness-proof-config
            items:
              - key: providers.json
                path: providers.json
        - name: proof-snapshot
          configMap:
            name: jobintel-politeness-proof-config
            items:
              - key: index.html
                path: index.html
