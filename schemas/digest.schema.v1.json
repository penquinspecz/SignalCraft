{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "digest schema v1",
  "type": "object",
  "required": [
    "digest_schema_version",
    "run_id",
    "candidate_id",
    "generated_at_utc",
    "quiet_mode",
    "notify",
    "source_artifacts",
    "current_run",
    "cadence",
    "notable_changes"
  ],
  "properties": {
    "digest_schema_version": {
      "type": "integer",
      "enum": [
        1
      ]
    },
    "run_id": {
      "type": "string"
    },
    "candidate_id": {
      "type": "string"
    },
    "generated_at_utc": {
      "type": "string"
    },
    "quiet_mode": {
      "type": "boolean"
    },
    "notify": {
      "type": "object",
      "required": [
        "requested",
        "attempted",
        "status"
      ],
      "properties": {
        "requested": {
          "type": "boolean"
        },
        "attempted": {
          "type": "boolean"
        },
        "status": {
          "type": "string"
        }
      },
      "additionalProperties": false
    },
    "source_artifacts": {
      "type": "object",
      "required": [
        "run_health",
        "provider_availability",
        "explanation",
        "costs",
        "job_timeline"
      ],
      "properties": {
        "run_health": {
          "$ref": "#/$defs/file_pointer"
        },
        "provider_availability": {
          "$ref": "#/$defs/file_pointer"
        },
        "explanation": {
          "$ref": "#/$defs/file_pointer"
        },
        "costs": {
          "$ref": "#/$defs/file_pointer"
        },
        "job_timeline": {
          "$ref": "#/$defs/file_pointer"
        }
      },
      "additionalProperties": false
    },
    "current_run": {
      "type": "object",
      "required": [
        "run_health",
        "provider_availability",
        "costs",
        "top_jobs"
      ],
      "properties": {
        "run_health": {
          "type": "object",
          "required": [
            "status",
            "failed_stage",
            "failure_codes"
          ],
          "properties": {
            "status": {
              "type": [
                "string",
                "null"
              ]
            },
            "failed_stage": {
              "type": [
                "string",
                "null"
              ]
            },
            "failure_codes": {
              "type": "array",
              "items": {
                "type": "string"
              }
            }
          },
          "additionalProperties": false
        },
        "provider_availability": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/provider_entry"
          }
        },
        "costs": {
          "$ref": "#/$defs/cost_totals"
        },
        "top_jobs": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/top_job"
          }
        }
      },
      "additionalProperties": false
    },
    "cadence": {
      "type": "object",
      "required": [
        "daily",
        "weekly"
      ],
      "properties": {
        "daily": {
          "$ref": "#/$defs/cadence_window"
        },
        "weekly": {
          "$ref": "#/$defs/cadence_window"
        }
      },
      "additionalProperties": false
    },
    "notable_changes": {
      "$ref": "#/$defs/notable_changes"
    }
  },
  "$defs": {
    "file_pointer": {
      "type": "object",
      "required": [
        "path",
        "sha256",
        "bytes"
      ],
      "properties": {
        "path": {
          "type": [
            "string",
            "null"
          ]
        },
        "sha256": {
          "type": [
            "string",
            "null"
          ]
        },
        "bytes": {
          "type": [
            "integer",
            "null"
          ]
        }
      },
      "additionalProperties": false
    },
    "signal": {
      "type": "object",
      "required": [
        "name",
        "contribution"
      ],
      "properties": {
        "name": {
          "type": "string"
        },
        "contribution": {
          "type": "number"
        }
      },
      "additionalProperties": false
    },
    "top_job": {
      "type": "object",
      "required": [
        "job_hash",
        "rank",
        "score_total",
        "title",
        "company",
        "location",
        "apply_url",
        "provider",
        "profile",
        "notes",
        "top_positive_signals",
        "top_negative_signals"
      ],
      "properties": {
        "job_hash": {
          "type": "string"
        },
        "rank": {
          "type": "integer",
          "minimum": 1
        },
        "score_total": {
          "type": "number"
        },
        "title": {
          "type": [
            "string",
            "null"
          ]
        },
        "company": {
          "type": [
            "string",
            "null"
          ]
        },
        "location": {
          "type": [
            "string",
            "null"
          ]
        },
        "apply_url": {
          "type": [
            "string",
            "null"
          ]
        },
        "provider": {
          "type": [
            "string",
            "null"
          ]
        },
        "profile": {
          "type": [
            "string",
            "null"
          ]
        },
        "notes": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "top_positive_signals": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/signal"
          }
        },
        "top_negative_signals": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/signal"
          }
        }
      },
      "additionalProperties": false
    },
    "provider_entry": {
      "type": "object",
      "required": [
        "provider_id",
        "availability",
        "reason_code",
        "attempts_made"
      ],
      "properties": {
        "provider_id": {
          "type": "string"
        },
        "availability": {
          "type": "string"
        },
        "reason_code": {
          "type": [
            "string",
            "null"
          ]
        },
        "attempts_made": {
          "type": "integer"
        }
      },
      "additionalProperties": false
    },
    "cost_totals": {
      "type": "object",
      "required": [
        "ai_estimated_tokens",
        "ai_estimated_cost_usd",
        "embeddings_count"
      ],
      "properties": {
        "ai_estimated_tokens": {
          "type": "integer",
          "minimum": 0
        },
        "ai_estimated_cost_usd": {
          "type": "string"
        },
        "embeddings_count": {
          "type": "integer",
          "minimum": 0
        }
      },
      "additionalProperties": false
    },
    "cadence_window": {
      "type": "object",
      "required": [
        "window_days",
        "window_start_utc",
        "window_end_utc",
        "run_count",
        "run_ids",
        "status_counts",
        "cost_totals"
      ],
      "properties": {
        "window_days": {
          "type": "integer",
          "minimum": 1
        },
        "window_start_utc": {
          "type": "string"
        },
        "window_end_utc": {
          "type": "string"
        },
        "run_count": {
          "type": "integer",
          "minimum": 0
        },
        "run_ids": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "status_counts": {
          "type": "object",
          "additionalProperties": {
            "type": "integer",
            "minimum": 0
          }
        },
        "cost_totals": {
          "$ref": "#/$defs/cost_totals"
        }
      },
      "additionalProperties": false
    },
    "notable_change_event": {
      "type": "object",
      "required": [
        "job_hash",
        "change_hash",
        "observed_at_utc",
        "provider_id",
        "company",
        "title",
        "canonical_url",
        "changed_fields",
        "skill_tokens_added",
        "skill_tokens_removed",
        "seniority_shift",
        "location_shift",
        "compensation_shift",
        "candidate_skill_matches",
        "candidate_relevant",
        "significance_score"
      ],
      "properties": {
        "job_hash": {
          "type": "string"
        },
        "change_hash": {
          "type": [
            "string",
            "null"
          ]
        },
        "observed_at_utc": {
          "type": "string"
        },
        "provider_id": {
          "type": [
            "string",
            "null"
          ]
        },
        "company": {
          "type": [
            "string",
            "null"
          ]
        },
        "title": {
          "type": [
            "string",
            "null"
          ]
        },
        "canonical_url": {
          "type": [
            "string",
            "null"
          ]
        },
        "changed_fields": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "skill_tokens_added": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "skill_tokens_removed": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "seniority_shift": {
          "type": "boolean"
        },
        "location_shift": {
          "type": "boolean"
        },
        "compensation_shift": {
          "type": "boolean"
        },
        "candidate_skill_matches": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "candidate_relevant": {
          "type": "boolean"
        },
        "significance_score": {
          "type": "integer",
          "minimum": 1
        }
      },
      "additionalProperties": false
    },
    "notable_aggregate_provider": {
      "type": "object",
      "required": [
        "provider_id",
        "change_event_count",
        "job_count"
      ],
      "properties": {
        "provider_id": {
          "type": "string"
        },
        "change_event_count": {
          "type": "integer",
          "minimum": 0
        },
        "job_count": {
          "type": "integer",
          "minimum": 0
        }
      },
      "additionalProperties": false
    },
    "notable_aggregate_company": {
      "type": "object",
      "required": [
        "company",
        "change_event_count",
        "job_count"
      ],
      "properties": {
        "company": {
          "type": "string"
        },
        "change_event_count": {
          "type": "integer",
          "minimum": 0
        },
        "job_count": {
          "type": "integer",
          "minimum": 0
        }
      },
      "additionalProperties": false
    },
    "notable_window": {
      "type": "object",
      "required": [
        "window_days",
        "window_start_utc",
        "window_end_utc",
        "change_event_count",
        "notable_changes",
        "aggregates"
      ],
      "properties": {
        "window_days": {
          "type": "integer",
          "minimum": 1
        },
        "window_start_utc": {
          "type": "string"
        },
        "window_end_utc": {
          "type": "string"
        },
        "change_event_count": {
          "type": "integer",
          "minimum": 0
        },
        "notable_changes": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/notable_change_event"
          }
        },
        "aggregates": {
          "type": "object",
          "required": [
            "providers",
            "companies"
          ],
          "properties": {
            "providers": {
              "type": "array",
              "items": {
                "$ref": "#/$defs/notable_aggregate_provider"
              }
            },
            "companies": {
              "type": "array",
              "items": {
                "$ref": "#/$defs/notable_aggregate_company"
              }
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "notable_changes": {
      "type": "object",
      "required": [
        "thresholds",
        "windows"
      ],
      "properties": {
        "thresholds": {
          "type": "object",
          "required": [
            "min_skill_token_delta"
          ],
          "properties": {
            "min_skill_token_delta": {
              "type": "integer",
              "minimum": 1
            }
          },
          "additionalProperties": false
        },
        "windows": {
          "type": "object",
          "required": [
            "last_7_days",
            "last_14_days",
            "last_30_days"
          ],
          "properties": {
            "last_7_days": {
              "$ref": "#/$defs/notable_window"
            },
            "last_14_days": {
              "$ref": "#/$defs/notable_window"
            },
            "last_30_days": {
              "$ref": "#/$defs/notable_window"
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false
}
