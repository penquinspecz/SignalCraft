{
  "payload": {
    "input": {
      "action": "notify",
      "execution_id": "m19b-success-true-20260227T032245Z",
      "expected_account_id": "048622080012",
      "notification_topic_arn": "arn:aws:sns:us-east-1:048622080012:signalcraft-dr-notifications",
      "receipt_bucket": "jobintel-prod1",
      "receipt_prefix": "jobintel/dr-orchestrator/receipts",
      "region": "us-east-1",
      "status": "dr_orchestrator_phase_failed",
      "summary": {
        "failure_error": "States.TaskFailed",
        "failure_reason": "{\"SdkHttpMetadata\":{\"AllHttpHeaders\":{\"x-amzn-RequestId\":[\"a9effed2-f779-4708-a8b8-c7ad98d4dd11\"],\"Content-Length\":[\"9170\"],\"Date\":[\"Fri, 27 Feb 2026 03:23:02 GMT\"],\"Content-Type\":[\"application/x-amz-json-1.1\"]},\"HttpHeaders\":{\"Content-Length\":\"9170\",\"Content-Type\":\"application/x-amz-json-1.1\",\"Date\":\"Fri, 27 Feb 2026 03:23:02 GMT\",\"x-amzn-RequestId\":\"a9effed2-f779-4708-a8b8-c7ad98d4dd11\"},\"HttpStatusCode\":200},\"SdkResponseMetadata\":{\"RequestId\":\"a9effed2-f779-4708-a8b8-c7ad98d4dd11\"},\"Build\":{\"Arn\":\"arn:aws:codebuild:us-east-1:048622080012:build/signalcraft-dr-orchestrator-dr-infra:28fb7bd0-c651-4865-babe-388c4c7da8d1\",\"Artifacts\":{\"Location\":\"\",\"OverrideArtifactName\":false},\"BuildComplete\":true,\"BuildNumber\":1,\"BuildStatus\":\"FAILED\",\"Cache\":{\"Type\":\"NO_CACHE\"},\"CurrentPhase\":\"COMPLETED\",\"EncryptionKey\":\"arn:aws:kms:us-east-1:048622080012:alias/aws/s3\",\"EndTime\":1772162575446,\"Environment\":{\"ComputeType\":\"BUILD_GENERAL1_MEDIUM\",\"EnvironmentVariables\":[{\"Name\":\"RECEIPT_BUCKET\",\"Type\":\"PLAINTEXT\",\"Value\":\"jobintel-prod1\"},{\"Name\":\"TF_VAR_allowed_cidr\",\"Type\":\"PLAINTEXT\",\"Value\":\"10.0.0.0/8\"},{\"Name\":\"TF_BUNDLE_BUCKET\",\"Type\":\"PLAINTEXT\",\"Value\":\"jobintel-prod1\"},{\"Name\":\"EXECUTION_ID\",\"Type\":\"PLAINTEXT\",\"Value\":\"m19b-success-true-20260227T032245Z\"},{\"Name\":\"TF_VAR_instance_type\",\"Type\":\"PLAINTEXT\",\"Value\":\"t4g.small\"},{\"Name\":\"TF_VAR_subnet_id\",\"Type\":\"PLAINTEXT\",\"Value\":\"subnet-11001d5c\"},{\"Name\":\"AWS_REGION\",\"Type\":\"PLAINTEXT\",\"Value\":\"us-east-1\"},{\"Name\":\"TF_VAR_key_name\",\"Type\":\"PLAINTEXT\",\"Value\":\"\"},{\"Name\":\"TF_BUNDLE_KEY\",\"Type\":\"PLAINTEXT\",\"Value\":\"jobintel/dr-orchestrator/artifacts/dr-terraform-module.zip\"},{\"Name\":\"TF_STATE_KEY\",\"Type\":\"PLAINTEXT\",\"Value\":\"jobintel/dr/terraform/dr-runner.tfstate\"},{\"Name\":\"TF_VERSION\",\"Type\":\"PLAINTEXT\",\"Value\":\"1.8.5\"},{\"Name\":\"ACTION\",\"Type\":\"PLAINTEXT\",\"Value\":\"bringup\"},{\"Name\":\"TF_VAR_ami_id\",\"Type\":\"PLAINTEXT\",\"Value\":\"\"},{\"Name\":\"TF_VAR_region\",\"Type\":\"PLAINTEXT\",\"Value\":\"us-east-1\"},{\"Name\":\"EXPECTED_ACCOUNT_ID\",\"Type\":\"PLAINTEXT\",\"Value\":\"048622080012\"},{\"Name\":\"TF_VAR_vpc_id\",\"Type\":\"PLAINTEXT\",\"Value\":\"vpc-4362fc3e\"},{\"Name\":\"RECEIPT_PREFIX\",\"Type\":\"PLAINTEXT\",\"Value\":\"jobintel/dr-orchestrator/receipts\"},{\"Name\":\"TF_STATE_BUCKET\",\"Type\":\"PLAINTEXT\",\"Value\":\"signalcraft-dr-tfstate-048622080012-us-east-1\"},{\"Name\":\"TF_STATE_DYNAMODB_TABLE\",\"Type\":\"PLAINTEXT\",\"Value\":\"signalcraft-dr-tf-lock\"}],\"Image\":\"aws/codebuild/standard:7.0\",\"ImagePullCredentialsType\":\"CODEBUILD\",\"PrivilegedMode\":false,\"Type\":\"LINUX_CONTAINER\"},\"Id\":\"signalcraft-dr-orchestrator-dr-infra:28fb7bd0-c651-4865-babe-388c4c7da8d1\",\"Initiator\":\"states/signalcraft-dr-orchestrator-state-machine\",\"Logs\":{\"CloudWatchLogs\":{\"GroupName\":\"/aws/codebuild/signalcraft-dr-orchestrator-dr-infra\",\"Status\":\"ENABLED\"},\"CloudWatchLogsArn\":\"arn:aws:logs:us-east-1:048622080012:log-group:/aws/codebuild/signalcraft-dr-orchestrator-dr-infra:log-stream:28fb7bd0-c651-4865-babe-388c4c7da8d1\",\"DeepLink\":\"https://console.aws.amazon.com/cloudwatch/home?region=us-east-1#logsV2:log-groups/log-group/$252Faws$252Fcodebuild$252Fsignalcraft-dr-orchestrator-dr-infra/log-events/28fb7bd0-c651-4865-babe-388c4c7da8d1\",\"GroupName\":\"/aws/codebuild/signalcraft-dr-orchestrator-dr-infra\",\"S3Logs\":{\"EncryptionDisabled\":false,\"Status\":\"DISABLED\"},\"StreamName\":\"28fb7bd0-c651-4865-babe-388c4c7da8d1\"},\"Phases\":[{\"DurationInSeconds\":0,\"EndTime\":1772162570675,\"PhaseStatus\":\"SUCCEEDED\",\"PhaseType\":\"SUBMITTED\",\"StartTime\":1772162570573},{\"DurationInSeconds\":0,\"EndTime\":1772162571445,\"PhaseStatus\":\"SUCCEEDED\",\"PhaseType\":\"QUEUED\",\"StartTime\":1772162570675},{\"Contexts\":[{\"Message\":\"\",\"StatusCode\":\"\"}],\"DurationInSeconds\":3,\"EndTime\":1772162574669,\"PhaseStatus\":\"SUCCEEDED\",\"PhaseType\":\"PROVISIONING\",\"StartTime\":1772162571445},{\"Contexts\":[{\"Message\":\"did not find expected key at line 15\",\"StatusCode\":\"YAML_FILE_ERROR\"}],\"DurationInSeconds\":0,\"EndTime\":1772162575011,\"PhaseStatus\":\"FAILED\",\"PhaseType\":\"DOWNLOAD_SOURCE\",\"StartTime\":1772162574669},{\"Contexts\":[{\"Message\":\"\",\"StatusCode\":\"\"}],\"DurationInSeconds\":0,\"EndTime\":1772162575446,\"PhaseStatus\":\"SUCCEEDED\",\"PhaseType\":\"FINALIZING\",\"StartTime\":1772162575011},{\"PhaseType\":\"COMPLETED\",\"StartTime\":1772162575446}],\"ProjectName\":\"signalcraft-dr-orchestrator-dr-infra\",\"QueuedTimeoutInMinutes\":60,\"SecondarySourceVersions\":[],\"SecondarySources\":[],\"ServiceRole\":\"arn:aws:iam::048622080012:role/signalcraft-dr-orchestrator-codebuild-role\",\"Source\":{\"Buildspec\":\"version: 0.2\\nenv:\\n  shell: bash\\nphases:\\n  install:\\n    commands:\\n      - set -euo pipefail\\n      - apt-get update\\n      - DEBIAN_FRONTEND=noninteractive apt-get install -y unzip curl jq >/dev/null\\n      - curl -fsSL -o /tmp/terraform.zip \\\"https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip\\\"\\n      - unzip -o /tmp/terraform.zip -d /usr/local/bin >/dev/null\\n      - terraform version\\n  build:\\n    commands:\\n      - set -euo pipefail\\n      - : \\\"${ACTION:?ACTION is required}\\\"\\n      - : \\\"${EXECUTION_ID:?EXECUTION_ID is required}\\\"\\n      - : \\\"${EXPECTED_ACCOUNT_ID:?EXPECTED_ACCOUNT_ID is required}\\\"\\n      - : \\\"${AWS_REGION:?AWS_REGION is required}\\\"\\n      - : \\\"${RECEIPT_BUCKET:?RECEIPT_BUCKET is required}\\\"\\n      - : \\\"${RECEIPT_PREFIX:?RECEIPT_PREFIX is required}\\\"\\n      - : \\\"${TF_BUNDLE_BUCKET:?TF_BUNDLE_BUCKET is required}\\\"\\n      - : \\\"${TF_BUNDLE_KEY:?TF_BUNDLE_KEY is required}\\\"\\n      - : \\\"${TF_STATE_BUCKET:?TF_STATE_BUCKET is required}\\\"\\n      - : \\\"${TF_STATE_KEY:?TF_STATE_KEY is required}\\\"\\n      - : \\\"${TF_STATE_DYNAMODB_TABLE:?TF_STATE_DYNAMODB_TABLE is required}\\\"\\n      - : \\\"${TF_VAR_region:?TF_VAR_region is required}\\\"\\n      - : \\\"${TF_VAR_vpc_id:?TF_VAR_vpc_id is required}\\\"\\n      - : \\\"${TF_VAR_subnet_id:?TF_VAR_subnet_id is required}\\\"\\n      - : \\\"${TF_VAR_allowed_cidr:?TF_VAR_allowed_cidr is required}\\\"\\n      - ACTUAL_ACCOUNT_ID=\\\"$(aws sts get-caller-identity --query Account --output text)\\\"\\n      - |\\n        if [[ \\\"${ACTUAL_ACCOUNT_ID}\\\" != \\\"${EXPECTED_ACCOUNT_ID}\\\" ]]; then\\n          echo \\\"account mismatch: expected=${EXPECTED_ACCOUNT_ID} actual=${ACTUAL_ACCOUNT_ID}\\\" >&2\\n          exit 1\\n        fi\\n      - WORK_DIR=\\\"/tmp/dr-terraform\\\"\\n      - rm -rf \\\"${WORK_DIR}\\\" /tmp/dr-terraform.zip\\n      - aws s3 cp \\\"s3://${TF_BUNDLE_BUCKET}/${TF_BUNDLE_KEY}\\\" /tmp/dr-terraform.zip\\n      - mkdir -p \\\"${WORK_DIR}\\\"\\n      - unzip -q /tmp/dr-terraform.zip -d \\\"${WORK_DIR}\\\"\\n      - cd \\\"${WORK_DIR}\\\"\\n      - |\\n        terraform init -input=false \\\\\\n          -backend-config=\\\"bucket=${TF_STATE_BUCKET}\\\" \\\\\\n          -backend-config=\\\"key=${TF_STATE_KEY}\\\" \\\\\\n          -backend-config=\\\"region=${AWS_REGION}\\\" \\\\\\n          -backend-config=\\\"dynamodb_table=${TF_STATE_DYNAMODB_TABLE}\\\" \\\\\\n          -backend-config=\\\"encrypt=true\\\"\\n      - terraform fmt -check\\n      - terraform validate\\n      - |\\n        tf_var_args=(\\n          -var \\\"region=${TF_VAR_region}\\\"\\n          -var \\\"vpc_id=${TF_VAR_vpc_id}\\\"\\n          -var \\\"subnet_id=${TF_VAR_subnet_id}\\\"\\n          -var \\\"allowed_cidr=${TF_VAR_allowed_cidr}\\\"\\n          -var \\\"instance_type=${TF_VAR_instance_type:-t4g.small}\\\"\\n        )\\n        if [[ -n \\\"${TF_VAR_key_name:-}\\\" ]]; then\\n          tf_var_args+=( -var \\\"key_name=${TF_VAR_key_name}\\\" )\\n        fi\\n        if [[ -n \\\"${TF_VAR_ami_id:-}\\\" ]]; then\\n          tf_var_args+=( -var \\\"ami_id=${TF_VAR_ami_id}\\\" )\\n        fi\\n\\n        case \\\"${ACTION}\\\" in\\n          bringup)\\n            terraform plan -input=false \\\"${tf_var_args[@]}\\\" -out=tfplan\\n            terraform apply -auto-approve tfplan\\n            ;;\\n          teardown)\\n            terraform plan -destroy -input=false \\\"${tf_var_args[@]}\\\" -out=tfplan-destroy\\n            terraform apply -auto-approve tfplan-destroy\\n            ;;\\n          *)\\n            echo \\\"unsupported ACTION=${ACTION}\\\" >&2\\n            exit 2\\n            ;;\\n        esac\\n      - terraform output -json > /tmp/dr_tf_outputs.json || echo '{}' > /tmp/dr_tf_outputs.json\\n      - RECEIPT_KEY=\\\"${RECEIPT_PREFIX}/${EXECUTION_ID}/codebuild-${ACTION}.json\\\"\\n      - |\\n        python3 - <<'PY' > /tmp/codebuild_receipt.json\\n        import datetime as dt\\n        import json\\n        import os\\n        from pathlib import Path\\n\\n        outputs_path = Path('/tmp/dr_tf_outputs.json')\\n        outputs = json.loads(outputs_path.read_text(encoding='utf-8')) if outputs_path.exists() else {}\\n\\n        payload = {\\n            'schema_version': 1,\\n            'timestamp_utc': dt.datetime.now(dt.timezone.utc).strftime('%Y-%m-%dT%H:%M:%SZ'),\\n            'phase': os.environ['ACTION'],\\n            'status': 'ok',\\n            'execution_id': os.environ['EXECUTION_ID'],\\n            'build_id': os.environ.get('CODEBUILD_BUILD_ID', ''),\\n            'account_id': os.environ.get('ACTUAL_ACCOUNT_ID', ''),\\n            'region': os.environ['AWS_REGION'],\\n            'terraform_backend': {\\n                'bucket': os.environ['TF_STATE_BUCKET'],\\n                'key': os.environ['TF_STATE_KEY'],\\n                'dynamodb_table': os.environ['TF_STATE_DYNAMODB_TABLE'],\\n            },\\n            'terraform_outputs': outputs,\\n        }\\n        print(json.dumps(payload, indent=2, sort_keys=True))\\n        PY\\n      - aws s3 cp /tmp/codebuild_receipt.json \\\"s3://${RECEIPT_BUCKET}/${RECEIPT_KEY}\\\" --content-type application/json\\n      - echo \\\"receipt=s3://${RECEIPT_BUCKET}/${RECEIPT_KEY}\\\"\\n\",\"GitCloneDepth\":0,\"InsecureSsl\":false,\"Type\":\"NO_SOURCE\"},\"StartTime\":1772162570573,\"TimeoutInMinutes\":30}}",
        "phase_name": "bringup"
      }
    },
    "result": {
      "account_id": "048622080012",
      "message": {
        "details": {
          "failure_error": "States.TaskFailed",
          "failure_reason": "{\"SdkHttpMetadata\":{\"AllHttpHeaders\":{\"x-amzn-RequestId\":[\"a9effed2-f779-4708-a8b8-c7ad98d4dd11\"],\"Content-Length\":[\"9170\"],\"Date\":[\"Fri, 27 Feb 2026 03:23:02 GMT\"],\"Content-Type\":[\"application/x-amz-json-1.1\"]},\"HttpHeaders\":{\"Content-Length\":\"9170\",\"Content-Type\":\"application/x-amz-json-1.1\",\"Date\":\"Fri, 27 Feb 2026 03:23:02 GMT\",\"x-amzn-RequestId\":\"a9effed2-f779-4708-a8b8-c7ad98d4dd11\"},\"HttpStatusCode\":200},\"SdkResponseMetadata\":{\"RequestId\":\"a9effed2-f779-4708-a8b8-c7ad98d4dd11\"},\"Build\":{\"Arn\":\"arn:aws:codebuild:us-east-1:048622080012:build/signalcraft-dr-orchestrator-dr-infra:28fb7bd0-c651-4865-babe-388c4c7da8d1\",\"Artifacts\":{\"Location\":\"\",\"OverrideArtifactName\":false},\"BuildComplete\":true,\"BuildNumber\":1,\"BuildStatus\":\"FAILED\",\"Cache\":{\"Type\":\"NO_CACHE\"},\"CurrentPhase\":\"COMPLETED\",\"EncryptionKey\":\"arn:aws:kms:us-east-1:048622080012:alias/aws/s3\",\"EndTime\":1772162575446,\"Environment\":{\"ComputeType\":\"BUILD_GENERAL1_MEDIUM\",\"EnvironmentVariables\":[{\"Name\":\"RECEIPT_BUCKET\",\"Type\":\"PLAINTEXT\",\"Value\":\"jobintel-prod1\"},{\"Name\":\"TF_VAR_allowed_cidr\",\"Type\":\"PLAINTEXT\",\"Value\":\"10.0.0.0/8\"},{\"Name\":\"TF_BUNDLE_BUCKET\",\"Type\":\"PLAINTEXT\",\"Value\":\"jobintel-prod1\"},{\"Name\":\"EXECUTION_ID\",\"Type\":\"PLAINTEXT\",\"Value\":\"m19b-success-true-20260227T032245Z\"},{\"Name\":\"TF_VAR_instance_type\",\"Type\":\"PLAINTEXT\",\"Value\":\"t4g.small\"},{\"Name\":\"TF_VAR_subnet_id\",\"Type\":\"PLAINTEXT\",\"Value\":\"subnet-11001d5c\"},{\"Name\":\"AWS_REGION\",\"Type\":\"PLAINTEXT\",\"Value\":\"us-east-1\"},{\"Name\":\"TF_VAR_key_name\",\"Type\":\"PLAINTEXT\",\"Value\":\"\"},{\"Name\":\"TF_BUNDLE_KEY\",\"Type\":\"PLAINTEXT\",\"Value\":\"jobintel/dr-orchestrator/artifacts/dr-terraform-module.zip\"},{\"Name\":\"TF_STATE_KEY\",\"Type\":\"PLAINTEXT\",\"Value\":\"jobintel/dr/terraform/dr-runner.tfstate\"},{\"Name\":\"TF_VERSION\",\"Type\":\"PLAINTEXT\",\"Value\":\"1.8.5\"},{\"Name\":\"ACTION\",\"Type\":\"PLAINTEXT\",\"Value\":\"bringup\"},{\"Name\":\"TF_VAR_ami_id\",\"Type\":\"PLAINTEXT\",\"Value\":\"\"},{\"Name\":\"TF_VAR_region\",\"Type\":\"PLAINTEXT\",\"Value\":\"us-east-1\"},{\"Name\":\"EXPECTED_ACCOUNT_ID\",\"Type\":\"PLAINTEXT\",\"Value\":\"048622080012\"},{\"Name\":\"TF_VAR_vpc_id\",\"Type\":\"PLAINTEXT\",\"Value\":\"vpc-4362fc3e\"},{\"Name\":\"RECEIPT_PREFIX\",\"Type\":\"PLAINTEXT\",\"Value\":\"jobintel/dr-orchestrator/receipts\"},{\"Name\":\"TF_STATE_BUCKET\",\"Type\":\"PLAINTEXT\",\"Value\":\"signalcraft-dr-tfstate-048622080012-us-east-1\"},{\"Name\":\"TF_STATE_DYNAMODB_TABLE\",\"Type\":\"PLAINTEXT\",\"Value\":\"signalcraft-dr-tf-lock\"}],\"Image\":\"aws/codebuild/standard:7.0\",\"ImagePullCredentialsType\":\"CODEBUILD\",\"PrivilegedMode\":false,\"Type\":\"LINUX_CONTAINER\"},\"Id\":\"signalcraft-dr-orchestrator-dr-infra:28fb7bd0-c651-4865-babe-388c4c7da8d1\",\"Initiator\":\"states/signalcraft-dr-orchestrator-state-machine\",\"Logs\":{\"CloudWatchLogs\":{\"GroupName\":\"/aws/codebuild/signalcraft-dr-orchestrator-dr-infra\",\"Status\":\"ENABLED\"},\"CloudWatchLogsArn\":\"arn:aws:logs:us-east-1:048622080012:log-group:/aws/codebuild/signalcraft-dr-orchestrator-dr-infra:log-stream:28fb7bd0-c651-4865-babe-388c4c7da8d1\",\"DeepLink\":\"https://console.aws.amazon.com/cloudwatch/home?region=us-east-1#logsV2:log-groups/log-group/$252Faws$252Fcodebuild$252Fsignalcraft-dr-orchestrator-dr-infra/log-events/28fb7bd0-c651-4865-babe-388c4c7da8d1\",\"GroupName\":\"/aws/codebuild/signalcraft-dr-orchestrator-dr-infra\",\"S3Logs\":{\"EncryptionDisabled\":false,\"Status\":\"DISABLED\"},\"StreamName\":\"28fb7bd0-c651-4865-babe-388c4c7da8d1\"},\"Phases\":[{\"DurationInSeconds\":0,\"EndTime\":1772162570675,\"PhaseStatus\":\"SUCCEEDED\",\"PhaseType\":\"SUBMITTED\",\"StartTime\":1772162570573},{\"DurationInSeconds\":0,\"EndTime\":1772162571445,\"PhaseStatus\":\"SUCCEEDED\",\"PhaseType\":\"QUEUED\",\"StartTime\":1772162570675},{\"Contexts\":[{\"Message\":\"\",\"StatusCode\":\"\"}],\"DurationInSeconds\":3,\"EndTime\":1772162574669,\"PhaseStatus\":\"SUCCEEDED\",\"PhaseType\":\"PROVISIONING\",\"StartTime\":1772162571445},{\"Contexts\":[{\"Message\":\"did not find expected key at line 15\",\"StatusCode\":\"YAML_FILE_ERROR\"}],\"DurationInSeconds\":0,\"EndTime\":1772162575011,\"PhaseStatus\":\"FAILED\",\"PhaseType\":\"DOWNLOAD_SOURCE\",\"StartTime\":1772162574669},{\"Contexts\":[{\"Message\":\"\",\"StatusCode\":\"\"}],\"DurationInSeconds\":0,\"EndTime\":1772162575446,\"PhaseStatus\":\"SUCCEEDED\",\"PhaseType\":\"FINALIZING\",\"StartTime\":1772162575011},{\"PhaseType\":\"COMPLETED\",\"StartTime\":1772162575446}],\"ProjectName\":\"signalcraft-dr-orchestrator-dr-infra\",\"QueuedTimeoutInMinutes\":60,\"SecondarySourceVersions\":[],\"SecondarySources\":[],\"ServiceRole\":\"arn:aws:iam::048622080012:role/signalcraft-dr-orchestrator-codebuild-role\",\"Source\":{\"Buildspec\":\"version: 0.2\\nenv:\\n  shell: bash\\nphases:\\n  install:\\n    commands:\\n      - set -euo pipefail\\n      - apt-get update\\n      - DEBIAN_FRONTEND=noninteractive apt-get install -y unzip curl jq >/dev/null\\n      - curl -fsSL -o /tmp/terraform.zip \\\"https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip\\\"\\n      - unzip -o /tmp/terraform.zip -d /usr/local/bin >/dev/null\\n      - terraform version\\n  build:\\n    commands:\\n      - set -euo pipefail\\n      - : \\\"${ACTION:?ACTION is required}\\\"\\n      - : \\\"${EXECUTION_ID:?EXECUTION_ID is required}\\\"\\n      - : \\\"${EXPECTED_ACCOUNT_ID:?EXPECTED_ACCOUNT_ID is required}\\\"\\n      - : \\\"${AWS_REGION:?AWS_REGION is required}\\\"\\n      - : \\\"${RECEIPT_BUCKET:?RECEIPT_BUCKET is required}\\\"\\n      - : \\\"${RECEIPT_PREFIX:?RECEIPT_PREFIX is required}\\\"\\n      - : \\\"${TF_BUNDLE_BUCKET:?TF_BUNDLE_BUCKET is required}\\\"\\n      - : \\\"${TF_BUNDLE_KEY:?TF_BUNDLE_KEY is required}\\\"\\n      - : \\\"${TF_STATE_BUCKET:?TF_STATE_BUCKET is required}\\\"\\n      - : \\\"${TF_STATE_KEY:?TF_STATE_KEY is required}\\\"\\n      - : \\\"${TF_STATE_DYNAMODB_TABLE:?TF_STATE_DYNAMODB_TABLE is required}\\\"\\n      - : \\\"${TF_VAR_region:?TF_VAR_region is required}\\\"\\n      - : \\\"${TF_VAR_vpc_id:?TF_VAR_vpc_id is required}\\\"\\n      - : \\\"${TF_VAR_subnet_id:?TF_VAR_subnet_id is required}\\\"\\n      - : \\\"${TF_VAR_allowed_cidr:?TF_VAR_allowed_cidr is required}\\\"\\n      - ACTUAL_ACCOUNT_ID=\\\"$(aws sts get-caller-identity --query Account --output text)\\\"\\n      - |\\n        if [[ \\\"${ACTUAL_ACCOUNT_ID}\\\" != \\\"${EXPECTED_ACCOUNT_ID}\\\" ]]; then\\n          echo \\\"account mismatch: expected=${EXPECTED_ACCOUNT_ID} actual=${ACTUAL_ACCOUNT_ID}\\\" >&2\\n          exit 1\\n        fi\\n      - WORK_DIR=\\\"/tmp/dr-terraform\\\"\\n      - rm -rf \\\"${WORK_DIR}\\\" /tmp/dr-terraform.zip\\n      - aws s3 cp \\\"s3://${TF_BUNDLE_BUCKET}/${TF_BUNDLE_KEY}\\\" /tmp/dr-terraform.zip\\n      - mkdir -p \\\"${WORK_DIR}\\\"\\n      - unzip -q /tmp/dr-terraform.zip -d \\\"${WORK_DIR}\\\"\\n      - cd \\\"${WORK_DIR}\\\"\\n      - |\\n        terraform init -input=false \\\\\\n          -backend-config=\\\"bucket=${TF_STATE_BUCKET}\\\" \\\\\\n          -backend-config=\\\"key=${TF_STATE_KEY}\\\" \\\\\\n          -backend-config=\\\"region=${AWS_REGION}\\\" \\\\\\n          -backend-config=\\\"dynamodb_table=${TF_STATE_DYNAMODB_TABLE}\\\" \\\\\\n          -backend-config=\\\"encrypt=true\\\"\\n      - terraform fmt -check\\n      - terraform validate\\n      - |\\n        tf_var_args=(\\n          -var \\\"region=${TF_VAR_region}\\\"\\n          -var \\\"vpc_id=${TF_VAR_vpc_id}\\\"\\n          -var \\\"subnet_id=${TF_VAR_subnet_id}\\\"\\n          -var \\\"allowed_cidr=${TF_VAR_allowed_cidr}\\\"\\n          -var \\\"instance_type=${TF_VAR_instance_type:-t4g.small}\\\"\\n        )\\n        if [[ -n \\\"${TF_VAR_key_name:-}\\\" ]]; then\\n          tf_var_args+=( -var \\\"key_name=${TF_VAR_key_name}\\\" )\\n        fi\\n        if [[ -n \\\"${TF_VAR_ami_id:-}\\\" ]]; then\\n          tf_var_args+=( -var \\\"ami_id=${TF_VAR_ami_id}\\\" )\\n        fi\\n\\n        case \\\"${ACTION}\\\" in\\n          bringup)\\n            terraform plan -input=false \\\"${tf_var_args[@]}\\\" -out=tfplan\\n            terraform apply -auto-approve tfplan\\n            ;;\\n          teardown)\\n            terraform plan -destroy -input=false \\\"${tf_var_args[@]}\\\" -out=tfplan-destroy\\n            terraform apply -auto-approve tfplan-destroy\\n            ;;\\n          *)\\n            echo \\\"unsupported ACTION=${ACTION}\\\" >&2\\n            exit 2\\n            ;;\\n        esac\\n      - terraform output -json > /tmp/dr_tf_outputs.json || echo '{}' > /tmp/dr_tf_outputs.json\\n      - RECEIPT_KEY=\\\"${RECEIPT_PREFIX}/${EXECUTION_ID}/codebuild-${ACTION}.json\\\"\\n      - |\\n        python3 - <<'PY' > /tmp/codebuild_receipt.json\\n        import datetime as dt\\n        import json\\n        import os\\n        from pathlib import Path\\n\\n        outputs_path = Path('/tmp/dr_tf_outputs.json')\\n        outputs = json.loads(outputs_path.read_text(encoding='utf-8')) if outputs_path.exists() else {}\\n\\n        payload = {\\n            'schema_version': 1,\\n            'timestamp_utc': dt.datetime.now(dt.timezone.utc).strftime('%Y-%m-%dT%H:%M:%SZ'),\\n            'phase': os.environ['ACTION'],\\n            'status': 'ok',\\n            'execution_id': os.environ['EXECUTION_ID'],\\n            'build_id': os.environ.get('CODEBUILD_BUILD_ID', ''),\\n            'account_id': os.environ.get('ACTUAL_ACCOUNT_ID', ''),\\n            'region': os.environ['AWS_REGION'],\\n            'terraform_backend': {\\n                'bucket': os.environ['TF_STATE_BUCKET'],\\n                'key': os.environ['TF_STATE_KEY'],\\n                'dynamodb_table': os.environ['TF_STATE_DYNAMODB_TABLE'],\\n            },\\n            'terraform_outputs': outputs,\\n        }\\n        print(json.dumps(payload, indent=2, sort_keys=True))\\n        PY\\n      - aws s3 cp /tmp/codebuild_receipt.json \\\"s3://${RECEIPT_BUCKET}/${RECEIPT_KEY}\\\" --content-type application/json\\n      - echo \\\"receipt=s3://${RECEIPT_BUCKET}/${RECEIPT_KEY}\\\"\\n\",\"GitCloneDepth\":0,\"InsecureSsl\":false,\"Type\":\"NO_SOURCE\"},\"StartTime\":1772162570573,\"TimeoutInMinutes\":30}}",
          "phase_name": "bringup"
        },
        "execution_id": "m19b-success-true-20260227T032245Z",
        "kind": "dr_orchestrator_status",
        "status": "dr_orchestrator_phase_failed",
        "timestamp_utc": "2026-02-27T03:23:02Z"
      },
      "message_id": "cb7608ab-dd38-5ada-b4dd-6ab0cd6f5ed7",
      "published": true,
      "region": "us-east-1"
    }
  },
  "phase": "notify",
  "schema_version": 1,
  "status": "ok",
  "timestamp_utc": "2026-02-27T03:23:03Z"
}
