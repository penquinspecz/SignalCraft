#!/usr/bin/env bash
set -euo pipefail

if command -v gitleaks >/dev/null 2>&1; then
  gitleaks protect --staged --redact --verbose
  exit 0
fi

# Fallback lightweight staged-scan when gitleaks is unavailable.
staged_files="$(git diff --cached --name-only --diff-filter=ACM || true)"
[[ -z "${staged_files}" ]] && exit 0

pattern='AKIA[0-9A-Z]{16}|github_pat_[A-Za-z0-9_]{20,}|ghp_[A-Za-z0-9]{20,}|sk-[A-Za-z0-9]{20,}|https://discord\.com/api/webhooks/[0-9A-Za-z_-]+/[0-9A-Za-z_-]+'
if git diff --cached -U0 -- ${staged_files} | rg -n -e "${pattern}" >/dev/null 2>&1; then
  echo "[FAIL] potential secret detected in staged diff; install gitleaks for full scan" >&2
  exit 1
fi
