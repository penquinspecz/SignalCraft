name: ci

on:
  push:
    branches: [main]
  pull_request:

jobs:
  fast:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        id: setup-python
        with:
          python-version: "3.14.3"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt
      - name: Fetch PR base ref (for changelog policy diff)
        run: git fetch --no-tags --depth=1 origin "${{ github.base_ref }}"
      - name: Changelog policy
        run: GITHUB_BASE_REF="origin/${{ github.base_ref }}" make changelog-policy
      - name: PR label policy (warn-only)
        run: python scripts/check_pr_label_policy.py --event-path "$GITHUB_EVENT_PATH" --head-ref "${{ github.head_ref }}"
      - name: Restore venv cache
        id: venv-cache
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-v3-fast-${{ runner.os }}-${{ runner.arch }}-img-${{ env.ImageVersion }}-py3.14.3-${{ hashFiles('requirements.txt', 'requirements-dev.txt') }}
      - name: Cache diagnostics
        run: |
          echo "setup-python pip cache-hit=${{ steps.setup-python.outputs.cache-hit }}"
          echo "venv cache-hit=${{ steps.venv-cache.outputs.cache-hit }}"
          python -m pip cache dir
          python -m pip cache info || true
      - name: Install deps
        if: steps.venv-cache.outputs.cache-hit != 'true'
        run: |
          python -m venv .venv
          .venv/bin/python -m pip install --upgrade pip==25.0.1 setuptools wheel pip-tools==7.4.1
          .venv/bin/python -m pip install -r requirements.txt -r requirements-dev.txt
          .venv/bin/python -m pip install -e .
      - name: Dependency vulnerability audit (runtime, non-flaky retries)
        run: .venv/bin/python scripts/security_dependency_check.py --requirements requirements.txt
      - name: Fast feedback (ruff + pytest)
        run: make ci-fast

  doctor:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.14.3"
      - name: Python/platform fingerprint
        run: |
          python --version
          python - <<'PY'
          import platform
          import sys
          print(f"python_executable={sys.executable}")
          print(f"python_version={sys.version}")
          print(f"platform={platform.platform()}")
          PY
      - name: Prepare .venv for doctor
        run: |
          python -m venv .venv
      - name: Doctor guardrails
        run: make doctor

  gate:
    runs-on: ubuntu-latest
    needs: doctor
    env:
      DOCKER_BUILDKIT: "1"
    steps:
      - name: Timing init
        run: |
          echo "CI_TIMER_EPOCH=$(date +%s)" >> "$GITHUB_ENV"
      - uses: actions/checkout@v4
      - name: Timing checkpoint (checkout)
        run: |
          set -euo pipefail
          now=$(date +%s)
          prev=${CI_TIMER_EPOCH:-$now}
          echo "::notice title=ci-timing::checkout_sec=$((now-prev))"
          echo "CI_TIMER_EPOCH=$now" >> "$GITHUB_ENV"
      - uses: actions/setup-python@v5
        id: setup-python
        with:
          python-version: "3.14.3"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt
      - name: Timing checkpoint (setup-python + pip cache)
        run: |
          set -euo pipefail
          now=$(date +%s)
          prev=${CI_TIMER_EPOCH:-$now}
          echo "::notice title=ci-timing::setup_python_and_pip_cache_sec=$((now-prev))"
          echo "CI_TIMER_EPOCH=$now" >> "$GITHUB_ENV"
      - name: Restore venv cache
        id: venv-cache
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-v3-gate-${{ runner.os }}-${{ runner.arch }}-img-${{ env.ImageVersion }}-py3.14.3-${{ hashFiles('requirements.txt', 'requirements-dev.txt') }}
      - name: Cache diagnostics
        run: |
          set -euo pipefail
          now=$(date +%s)
          prev=${CI_TIMER_EPOCH:-$now}
          echo "::notice title=ci-timing::venv_cache_restore_sec=$((now-prev))"
          echo "CI_TIMER_EPOCH=$now" >> "$GITHUB_ENV"
          echo "::group::cache diagnostics"
          echo "setup-python pip cache-hit=${{ steps.setup-python.outputs.cache-hit }}"
          echo "venv cache-hit=${{ steps.venv-cache.outputs.cache-hit }}"
          echo "::endgroup::"
          echo "::group::pip cache diagnostics"
          python -m pip cache dir
          python -m pip cache info || true
          du -sh ~/.cache/pip 2>/dev/null || true
          echo "::endgroup::"
          echo "::group::venv diagnostics"
          du -sh .venv 2>/dev/null || true
          echo "::endgroup::"
      - name: Python/platform fingerprint
        run: |
          python --version
          python - <<'PY'
          import platform
          import sys
          print(f"python_executable={sys.executable}")
          print(f"python_version={sys.version}")
          print(f"platform={platform.platform()}")
          PY
      - name: Install deps
        if: steps.venv-cache.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          start=$(date +%s)
          python -m venv .venv
          .venv/bin/python -m pip install --upgrade pip==25.0.1 setuptools wheel pip-tools==7.4.1
          .venv/bin/python -m pip install -r requirements.txt -r requirements-dev.txt
          .venv/bin/python -m pip install -e .
          end=$(date +%s)
          echo "::notice title=ci-timing::install_deps_sec=$((end-start))"
          echo "::group::pip cache diagnostics (post-install)"
          .venv/bin/python -m pip cache info || true
          du -sh ~/.cache/pip 2>/dev/null || true
          echo "::endgroup::"
      - name: Gate timings (pytest + snapshot + replay + docker truth)
        run: |
          set -euo pipefail
          timed() {
            local label="$1"
            shift
            local start end
            start=$(date +%s)
            echo "::group::${label}"
            "$@"
            end=$(date +%s)
            echo "::notice title=ci-timing::${label}_sec=$((end-start))"
            echo "::endgroup::"
          }
          # Keep behavior equivalent to `make gate-ci`:
          # pytest + snapshot immutability + replay smoke + gate-truth docker build.
          timed pytest .venv/bin/python -m pytest -q
          timed verify_snapshots_immutable env PYTHONPATH=src .venv/bin/python scripts/verify_snapshots_immutable.py
          timed replay_smoke env CAREERS_MODE=SNAPSHOT PYTHONPATH=src .venv/bin/python scripts/replay_smoke_fixture.py
          timed gate_truth_docker_build docker build --no-cache --build-arg RUN_TESTS=1 -t jobintel:tests .
      - name: Determinism contract checks
        run: |
          set -euo pipefail
          export JOBINTEL_DATA_DIR=/tmp/jobintel_ci_data
          export JOBINTEL_STATE_DIR=/tmp/jobintel_ci_state
          .venv/bin/python - <<'PY'
          from pathlib import Path
          import json
          from ji_engine.utils.verification import compute_sha256_file
          data_dir = Path("/tmp/jobintel_ci_data")
          state_dir = Path("/tmp/jobintel_ci_state")
          data_dir.mkdir(parents=True, exist_ok=True)
          run_dir = state_dir / "runs" / "ci-run"
          run_dir.mkdir(parents=True, exist_ok=True)
          ranked = data_dir / "openai_ranked_jobs.cs.json"
          ranked.write_text("[]", encoding="utf-8")
          report = {
              "run_id": "ci-run",
              "run_report_schema_version": 1,
              "verifiable_artifacts": {
                  "openai:cs:ranked_json": {
                      "path": ranked.name,
                      "sha256": compute_sha256_file(ranked),
                      "bytes": ranked.stat().st_size,
                      "hash_algo": "sha256",
                  }
              },
          }
          (run_dir / "run_report.json").write_text(json.dumps(report), encoding="utf-8")
          PY
          .venv/bin/python scripts/publish_s3.py --run-dir /tmp/jobintel_ci_state/runs/ci-run --plan --json
          .venv/bin/python scripts/replay_run.py --run-dir /tmp/jobintel_ci_state/runs/ci-run --profile cs --strict --json
      - name: CronJob smoke (offline)
        run: make cronjob-smoke
      - name: Roadmap discipline guard (warn-only)
        continue-on-error: true
        run: .venv/bin/python scripts/check_roadmap_discipline.py
